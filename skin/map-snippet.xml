<!-- Aggiorna la mappa quando cambia scena -->
<events onxmlscenechanged="if(layer[skin_map].visible, skin_addmapspots());" />
<!--
  map-snippet.xml
  Reusable snippet to add map support to a krpano skin.

  Usage:
  - Copy contents into your skin XML inside the <krpano> element OR
    add an <include url="skin/map-snippet.xml"/> at the appropriate place.
  - Avoid duplicating layers/actions if your skin already defines them.
  - Update API keys in the `skin_settings` block if you use Google/Bing.
-->

<!-- 1) Optional: skin_settings override (put this in your skin or in tour.xml to enable maps) -->
<skin_settings maps="true" maps_type="openstreetmaps" maps_bing_api_key="" maps_google_api_key="" maps_loadonfirstuse="false" />

<!-- 2) Control-bar button: paste inside the control bar buttons container -->
<layer name="skin_btn_map" style="skin_base|skin_glow"
       crop="64|128|64|64" align="left" x="90" y="0" scale="0.5"
       ondown="skin_showthumbs(false); skin_showmap();" visible="false" />

<!-- 3) Map container + map layer: paste into your skin layout (only add if not present) -->
<layer name="skin_map_container" type="container" align="leftop" width="100%" height="100%" bgroundedge="get:skin_settings.design_bgroundedge" maskchildren="true">
    <layer name="skin_map" state="closed" url="" visible="false" align="lefttop" width="100%" height="30%" x="0" y="0" zorder="1" lat="0" lng="0" zoom="10" bgalpha="0" maptype="satellite" onmapready="skin_addmapspots();">
        <maptypecontrol visible="true" align="righttop" x="5" y="5" buttonalign="v" scale.mobile="1.5" />
        <radar visible="false" headingoffset="0" />
        <spotstyle name="DEFAULT" url="vtourskin_mapspot.png" activeurl="vtourskin_mapspotactive.png" edge="bottom" x="-5" y="-8" scale="0.5" />
        <spotstyle name="ACTIVE_GREEN" url="vtourskin_mapspot.png" activeurl="vtourskin_mapspotactive_green.png" edge="bottom" x="-5" y="-8" scale="0.5" />
        <layer name="skin_map_zoom_in"  style="skin_base" visible="get:skin_settings.maps_zoombuttons" crop="9|512|46|64"  align="right" x="0" y="-40" zorder="2" ondown="layer[skin_map].zoomin();  skin_buttonglow(get(name));" onup="skin_buttonglow(null);" />
        <layer name="skin_map_zoom_out" style="skin_base" visible="get:skin_settings.maps_zoombuttons" crop="73|512|46|64" align="right" x="0" y="+40" zorder="2" ondown="layer[skin_map].zoomout(); skin_buttonglow(get(name));" onup="skin_buttonglow(null);" />
    </layer>
</layer>

<!-- 4) Action to show/hide the map (compatible with vtourskin logic) -->
<!-- Memorizza lo zoom iniziale solo la prima volta -->
<action name="skin_showmap" scope="local" args="show">
    if(!exists(initial_map_zoom), copy(initial_map_zoom, layer[skin_map].zoom));
    if(show == null, if(layer[skin_map].state == 'closed', set(show,true), set(show,false)); );
    if(show,
        skin_load_maps_plugin();
        tween(layer[skin_thumbs_container].alpha, 0.0, 0.25, default, set(layer[skin_thumbs_container].visible,false));
        set(layer[skin_map].visible, true);
        tween(layer[skin_map].alpha, 1.0, 0.25);
        set(layer[skin_map].state, 'opened');
        set(layer[skin_map].zoom, get(initial_map_zoom));
        calc(hh, area.pixelheight - skin_settings.controlbar_offset - layer[skin_control_bar].height - 32);
        calc(layer[skin_map].height, hh - skin_settings.controlbar_overlap);
        tween(layer[skin_scroll_layer].y, calc(hh - area.pixelheight), 0.5, easeOutQuint);
      ,
        if(layer[skin_map].state != 'closed',
            set(layer[skin_map].state, 'closed');
            tween(layer[skin_map].alpha, 0.0, 0.5, easeOutQuint);
            tween(layer[skin_scroll_layer].y, calc(-area.pixelheight + layer[skin_scroll_layer].y_offset), 0.5, easeOutQuint, set(layer[skin_map].visible,false) );
        );
    );
</action>

<!-- 5) Action to load the chosen maps plugin -->
<action name="skin_load_maps_plugin">
    if (!layer[skin_map].url,
        if(skin_settings.maps_type == 'bing',
            copy(layer[skin_map].key, skin_settings.maps_bing_api_key);
            set(layer[skin_map].url, '%VIEWER%/plugins/bingmaps.js');
          ,skin_settings.maps_type == 'google',
            copy(layer[skin_map].key, skin_settings.maps_google_api_key);
            set(layer[skin_map].url, '%VIEWER%/plugins/googlemaps.js');
          ,
            copy(layer[skin_map].tileprovider, skin_settings.maps_type);
            includexml("%VIEWER%/plugins/krpanomaps.xml",
                layer[skin_map].loadstyle("krpanomaps");
            );
        );
    );
</action>

<!-- 6) Action to add map spots from scenes (navigates to scene on spot click) -->
<action name="skin_addmapspots" scope="local">
    for(set(i,0), i LT scene.count, inc(i),
        if(scene[get(i)].lat,
            calc(spotname, 'spot' + i);
            calc(spotclickevent, 'skin_hidetooltips(); activatespot(' + spotname + '); skin_loadscene(' + scene[get(i)].name + ',get(skin_settings.loadscene_blend)); delayedcall(0.5,skin_showmap(false));' );
            copy(scene[get(i)].mapspotname, spotname);
            if(xml.scene == i,
                caller.addspot(get(spotname), get(scene[get(i)].lat), get(scene[get(i)].lng), get(scene[get(i)].heading), false, get(spotclickevent), 'ACTIVE_GREEN');
            ,
                caller.addspot(get(spotname), get(scene[get(i)].lat), get(scene[get(i)].lng), get(scene[get(i)].heading), false, get(spotclickevent), null);
            );
            if(skin_settings.tooltips_mapspots,
                set(layer[skin_map].spot[get(spotname)].tooltip, get(scene[get(i)].title) );
                txtadd(layer[skin_map].spot[get(spotname)].onover, 'set(hovering,true);',  get(style[skin_tooltips].onover:addevent) );
                txtadd(layer[skin_map].spot[get(spotname)].onout,  'set(hovering,false);', get(style[skin_tooltips].onout:addevent)  );
            );
        );
    );

    currentscene = xml.scene != null ? scene[get(xml.scene)] : null;
    if(currentscene, caller.activatespot( currentscene.mapspotname ); );
    if(currentscene AND isvalue(currentscene.lat) AND isvalue(currentscene.lng) AND isvalue(currentscene.mapzoom),
        caller.setcenter( get(currentscene.lat), get(currentscene.lng), get(currentscene.mapzoom) );
      ,
        caller.zoomToSpotsExtent();
    );
</action>
